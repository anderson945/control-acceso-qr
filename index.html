<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Accesos - Escuela de Padres</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f0f4f8; padding: 10px; }
  #reader {
    margin: 20px auto;
    width: 95vw;
    max-width: 500px;
    height: 400px;  /* altura fija para evitar errores en móviles */
  }
  .msg { margin-top: 20px; font-size: 22px; font-weight: bold; }
  .nombre { font-size: 28px; font-weight: bold; margin-top: 10px; color: #2c3e50; }
  .ok { color: green; }
  .bloqueado { color: red; }
  button {
    font-size: 20px;
    padding: 12px 25px;
    margin-top: 15px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background-color: #3498db;
    color: white;
  }
  button:hover { background-color: #2980b9; }
</style>
</head>
<body>
<h1>Escanear QR - Escuela de Padres</h1>
<div id="reader"></div>
<div id="mensaje" class="msg"></div>
<div id="nombreEstudiante" class="nombre"></div>
<button id="reiniciarBtn">Reiniciar escaneo</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx92TPknHLScO6XpFMmHbuHQR6CGkBSY2S2SubMD9G4pc_pQhWOgMMkmmiEWrlqyvai/exec";

// Inicializamos el escáner
let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 350 });
scanner.render(onScanSuccess);

// Función que procesa el QR
function procesarQR(qrData) {
  fetch(`${API_URL}?codigo=${qrData}`)
    .then(res => res.json())
    .then(resp => {
      const msgDiv = document.getElementById('mensaje');
      const nombreDiv = document.getElementById('nombreEstudiante');

      msgDiv.textContent = resp.mensaje;
      msgDiv.className = "msg " + (resp.status === "ok" ? "ok" :
                                   resp.status === "bloqueado" ? "bloqueado" : "");

      if(resp.status === "ok" || resp.status === "bloqueado") {
          nombreDiv.textContent = resp.nombre || "";
      } else {
          nombreDiv.textContent = "";
      }
    })
    .catch(err => {
      document.getElementById('mensaje').textContent = "Error de conexión con el servidor.";
      document.getElementById('nombreEstudiante').textContent = "";
      console.error(err);
    });
}

// Función que se ejecuta al escanear un QR
function onScanSuccess(qrData) {
  procesarQR(qrData);
}

// Botón para reiniciar escaneo sin errores
document.getElementById('reiniciarBtn').addEventListener('click', function() {
  scanner.clear().then(() => {
    document.getElementById('mensaje').textContent = "";
    document.getElementById('nombreEstudiante').textContent = "";
    scanner.render(onScanSuccess);
  }).catch(err => {
    console.error("Error reiniciando el escáner:", err);
  });
});
</script>
</body>
</html>

